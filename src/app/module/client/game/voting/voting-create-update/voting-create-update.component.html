<mat-drawer-container autosize class="!bg-transparent">
    <section id="main" class="p-5 md:p-10 flex flex-col mt-20">
        <mat-toolbar class="glassmorphic-container_dark !rounded-lg">
            <div class="flex justify-between w-full">
                <button matButton="elevated" (click)="goBack()">
                    <mat-icon>chevron_left</mat-icon>
                    <span i18n>Back</span>
                </button>
                <div class="flex gap-2">
                    <button matButton="tonal" color="primary" type="button" (click)="onSubmit()"
                        [disabled]="dishVoteForm.invalid  || creatingLoading()">
                        @if (creatingLoading()) {
                        <mat-icon class="!animate-spin">av_timer</mat-icon>
                        }
                        @else {
                        <mat-icon>save</mat-icon>
                        }
                        <span i18n>Create Voting</span>
                    </button>
                    <button [matTooltip]="openSidenav() ? 'Close side' : 'Open side'" i18n-matTooltip matIconButton
                        (click)="openSidenav.set(!openSidenav())"
                        [ngClass]="{'duration-300 rotate-180': openSidenav()}"
                        [attr.aria-label]="openSidenav() ? 'Close side' : 'Open side'"
                        [attr.title]="openSidenav() ? 'Close side' : 'Open side'">
                        <mat-icon>chevron_left</mat-icon>
                    </button>
                </div>
            </div>
        </mat-toolbar>

        <!-- Drag and Drop Area -->
        <div class="flex gap-6 mt-6 h-[80vh]">
            <!-- Available Dishes -->
            <div class="flex-1">
                <mat-card class="glassmorphic-container_dark !h-full">
                    <mat-card-header>
                        <mat-card-title>
                            <span
                                class="bg-gradient-to-r from-[#F3A446] to-[#A06235] text-transparent bg-clip-text">Available
                                Dishes</span>
                        </mat-card-title>
                        <mat-card-subtitle>Select collections or drag dishes to add them to voting</mat-card-subtitle>
                    </mat-card-header>
                    
                    <mat-card-content class="!h-full max-h-full overflow-y-auto">
                        <mat-tab-group class="h-full" animationDuration="300ms">
                            <mat-tab>
                                <ng-template mat-tab-label>
                                    <mat-icon class="mr-2">collections_bookmark</mat-icon>
                                    <span i18n>My Collections</span>
                                </ng-template>
                                <div class="pt-4">
                                    <app-voting-collection-picker (dishesSelected)="onCollectionDishesSelected($event)"></app-voting-collection-picker>
                                </div>
                            </mat-tab>
                            
                            <mat-tab>
                                <ng-template mat-tab-label>
                                    <mat-icon class="mr-2">restaurant_menu</mat-icon>
                                    <span i18n>All Dishes</span>
                                </ng-template>
                                <div class="pt-4">
                                    <mat-accordion class="mb-4">
                                        <mat-expansion-panel class="glassmorphic-container_dark">
                                            <mat-expansion-panel-header>
                                                <mat-panel-title i18n> Filter </mat-panel-title>
                                                <mat-panel-description i18n>Let's find your favorite dishes!</mat-panel-description>
                                            </mat-expansion-panel-header>
                                            <div class="max-h-40 overflow-y-auto mb-2 p-2">
                                                <app-dish-filter (search)="onSearch($event)"></app-dish-filter>
                                            </div>
                                        </mat-expansion-panel>
                                    </mat-accordion>
                        <div id="available-dishes" class="list h-full min-h-20 p-4 rounded-lg" cdkDropList
                            [cdkDropListData]="availableDishes()" [cdkDropListConnectedTo]="['selected-dishes']"
                            (cdkDropListDropped)="drop($event)">
                            @if (loading()) {
                            <div class="flex items-center justify-center h-full">
                                <mat-spinner diameter="30" class="text-gray-400"></mat-spinner>
                            </div>
                            }
                            @for (dish of availableDishes(); track dish) {
                            <div class="box bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg p-3 mb-2 cursor-move hover:bg-white/20 transition-colors"
                                cdkDrag>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <mat-icon class="text-gray-400">drag_indicator</mat-icon>
                                        <div>
                                            <div class="font-medium">{{ (dish.title | multiLanguage :
                                                localeID)?.data}}
                                            </div>
                                            <div class="text-sm text-gray-400">{{ (dish.shortDescription | multiLanguage
                                                :
                                                localeID)?.data?.slice(0, 30)}}...</div>
                                        </div>
                                    </div>
                                    <button mat-icon-button
                                        class="preview-btn opacity-0 group-hover:opacity-100 transition-opacity"
                                        (mouseenter)="showDishPreview($event, dish)" (mouseleave)="hideDishPreview()"
                                        matTooltip="Preview dish" matTooltipPosition="above"
                                        aria-label="Preview dish" title="Preview dish">
                                        <mat-icon class="text-gray-400">visibility</mat-icon>
                                    </button>
                                </div>
                                <div *cdkDragPlaceholder class="bg-gray-200/50 rounded-lg h-16"></div>
                            </div>
                            }
                            @if (availableDishes().length === 0) {
                            <div class="text-center text-gray-500 mt-8">
                                No dishes available
                            </div>
                            }
                        </div>
                        
                        <mat-paginator [length]="total()" [pageSizeOptions]="[10, 25, 50, 100]"
                            [pageIndex]="currentPage() - 1" [pageSize]="limit()" (page)="paginatorChange($event)"
                            showFirstLastButtons aria-label="Select page">
                        </mat-paginator>
                                </div>
                            </mat-tab>
                        </mat-tab-group>
                    </mat-card-content>
                </mat-card>
            </div>

            <!-- Selected Dishes for Voting -->
            <div class="flex-1">
                <mat-card class="glassmorphic-container_dark !h-full">
                    <mat-card-header>
                        <mat-card-title-group>
                            <mat-card-title>
                                <span class="bg-gradient-to-r from-[#F3A446] to-[#A06235] text-transparent bg-clip-text"
                                    i18n>
                                    Voting Dishes
                                </span>
                            </mat-card-title>
                            <mat-card-subtitle>
                                <span i18n>
                                    Dishes included in the voting
                                </span>
                            </mat-card-subtitle>
                            <div class="flex gap-2">
                                <button matIconButton (click)="clearSelectedDishes()"
                                    [disabled]="selectedDishes().length === 0" matTooltip="Clear all selected dishes"
                                    i18n-matTooltip matTooltipPosition="above" aria-label="Clear all selected dishes" title="Clear all selected dishes">
                                    <mat-icon class="text-red-400">delete</mat-icon>
                                </button>
                                <button matIconButton (click)="addCustomDish()" matTooltip="Add custom dish"
                                    i18n-matTooltip matTooltipPosition="above" aria-label="Add custom dish" title="Add custom dish">
                                    <mat-icon class="text-green-400">control_point_duplicate</mat-icon>
                                </button>
                            </div>
                        </mat-card-title-group>
                    </mat-card-header>
                    <mat-card-content class="!h-full max-h-full overflow-y-auto">
                        <div id="selected-dishes" class="list p-4 min-h-50 rounded-lg" cdkDropList
                            [cdkDropListData]="selectedDishes()" [cdkDropListConnectedTo]="['available-dishes']"
                            (cdkDropListDropped)="drop($event)">
                            @for (dish of selectedDishes(); track dish) {
                            <div class="group box bg-green-500/10 backdrop-blur-sm border border-green-500/20 rounded-lg p-3 mb-2 cursor-move hover:bg-green-500/20 transition-colors"
                                cdkDrag>
                                <button matIconButton (click)="removeDish(dish)"
                                    class="!absolute !-top-4 !-left-4 opacity-0 group-hover:!opacity-100 !transition-opacity"
                                    aria-label="Remove dish" title="Remove dish">
                                    <mat-icon class="!text-red-400">close</mat-icon>
                                </button>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <mat-icon class="text-green-400">drag_indicator</mat-icon>
                                        <div>
                                            <div class="font-medium">{{ (dish.title | multiLanguage :
                                                localeID)?.data}}</div>
                                            <div class="text-sm text-gray-400">{{ (dish.shortDescription | multiLanguage
                                                :
                                                localeID)?.data?.slice(0, 30)}}...</div>
                                        </div>
                                    </div>
                                    <button mat-icon-button
                                        class="preview-btn opacity-0 group-hover:opacity-100 transition-opacity"
                                        (mouseenter)="showDishPreview($event, dish)" (mouseleave)="hideDishPreview()"
                                        matTooltip="Preview dish" matTooltipPosition="above"
                                        aria-label="Preview dish" title="Preview dish">
                                        <mat-icon class="text-green-400">visibility</mat-icon>
                                    </button>
                                </div>
                                <div *cdkDragPlaceholder class="bg-green-200/50 rounded-lg h-16"></div>
                            </div>
                            }
                            @if (selectedDishes().length === 0) {
                            <div class="text-center text-gray-500 mt-8">
                                Drop dishes here to add to voting
                            </div>
                            }
                        </div>
                        <mat-divider></mat-divider>
                        @if (customDishes().length > 0) {
                        <div class="list p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-300" i18n>Custom Dishes</h3>
                            @for (customDish of customDishes(); track customDish) {
                            <div
                                class="group box bg-blue-500/10 backdrop-blur-sm border border-blue-500/20 rounded-lg p-3 mb-2 hover:bg-blue-500/20 transition-colors">
                                <button matIconButton (click)="removeCustomDish(customDish)"
                                    class="!absolute !-top-4 !-left-4 opacity-0 group-hover:!opacity-100 !transition-opacity"
                                    aria-label="Remove custom dish" title="Remove custom dish">
                                    <mat-icon class="!text-red-400">close</mat-icon>
                                </button>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <mat-icon class="text-blue-400">restaurant</mat-icon>
                                        <div>
                                            <div class="font-medium">{{ customDish.customTitle }}</div>
                                        </div>
                                    </div>
                                    <a mat-icon-button [href]="customDish.slug" target="_blank"
                                        class="preview-btn opacity-0 group-hover:opacity-100 transition-opacity"
                                        aria-label="Open dish in new tab" title="Open dish in new tab">
                                        <mat-icon class="text-blue-400">visibility</mat-icon>
                                    </a>
                                </div>
                            </div>
                            }
                        </div>
                        }
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </section>
    <mat-drawer mode="side" [opened]="openSidenav()" position="end" class="glassmorphic-container_dark !rounded-lg mt-20">
        <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" class="mt-10">
            <mat-tab label="Voting Details" i18n-label>
                <div class="flex flex-col gap-5 p-5">
                    <div class="flex-1 mt-5">
                        <form [formGroup]="dishVoteForm" (ngSubmit)="onSubmit()" class="space-y-6">
                            <!-- Title and Description -->
                            <mat-card class="glassmorphic-container_dark">
                                <mat-card-header>
                                    <mat-card-title>Voting Details</mat-card-title>
                                </mat-card-header>
                                <mat-card-content class="space-y-4 mt-2">
                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Title</mat-label>
                                        <input matInput required formControlName="title"
                                            placeholder="Enter voting title">
                                        <mat-error *ngIf="dishVoteForm.get('title')?.hasError('required')">
                                            Title is required
                                        </mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="w-full">
                                        <mat-label>Description</mat-label>
                                        <textarea matInput formControlName="description"
                                            placeholder="Enter voting description" rows="3"></textarea>
                                    </mat-form-field>
                                </mat-card-content>
                            </mat-card>
                        </form>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-drawer>
</mat-drawer-container>

<!-- Overlay Template for Dish Preview -->
<ng-template #dishPreviewTemplate>
    <div class="slide-in-blurred-right">
        <app-dish-card-fancy [dish]="selectedDishForPreview"></app-dish-card-fancy>
    </div>
</ng-template>